import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilder, FormGroup, Validators, ReactiveFormsModule, AbstractControl, ValidationErrors } from '@angular/forms';
import { Router } from '@angular/router';
import { AuthService } from '../../core/services/auth.service';
import { UserService } from '../../core/services/user.service';
import { User } from '../../shared/models/user.model';
import { UserRole } from '../../shared/interfaces/role.interface';
import { updateProfile, updatePassword } from '@angular/fire/auth';
import { getStorage, ref, uploadBytes, getDownloadURL } from '@angular/fire/storage';

@Component({
  selector: 'app-user-profile',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './user-profile.html',
  styleUrl: './user-profile.css',
})
export class UserProfile implements OnInit {
  @ViewChild('photoInput') photoInput!: ElementRef<HTMLInputElement>;

  profileForm!: FormGroup;
  currentUser: any = null;
  userData: User | null = null;
  loading = true;
  saving = false;
  showPasswordChange = false;
  successMessage = '';
  errorMessage = '';
  selectedFile: File | null = null;

  constructor(
    private fb: FormBuilder,
    private authService: AuthService,
    private userService: UserService,
    private router: Router
  ) {}

  ngOnInit(): void {
    console.log('üîµ UserProfile ngOnInit - Inicializando...');
    this.initializeForm();
    console.log('üîµ Formulario inicializado');

    // Suscribirse a los cambios del usuario
    this.authService.user$.subscribe(user => {
      console.log('üîµ user$ emiti√≥:', user);
      if (user) {
        this.currentUser = user;
        console.log('üîµ Usuario autenticado, cargando datos...');
        this.loadUserData();
      } else {
        console.log('‚ö†Ô∏è No hay usuario, redirigiendo a login');
        this.loading = false;
        this.router.navigate(['/login']);
      }
    });
  }

  /**
   * Inicializar el formulario con validadores
   */
  initializeForm(): void {
    this.profileForm = this.fb.group({
      displayName: ['', [Validators.required, Validators.minLength(3)]],
      newPassword: [''],
      confirmPassword: ['']
    }, {
      validators: this.passwordMatchValidator
    });
  }

  /**
   * Validador personalizado para verificar que las contrase√±as coincidan
   */
  passwordMatchValidator(control: AbstractControl): ValidationErrors | null {
    const newPassword = control.get('newPassword');
    const confirmPassword = control.get('confirmPassword');

    if (!newPassword || !confirmPassword) {
      return null;
    }

    // Si hay nueva contrase√±a, debe tener al menos 6 caracteres
    if (newPassword.value && newPassword.value.length < 6) {
      newPassword.setErrors({ minlength: true });
      return { minlength: true };
    }

    // Si hay contrase√±a, la confirmaci√≥n debe coincidir
    if (newPassword.value && newPassword.value !== confirmPassword.value) {
      confirmPassword.setErrors({ mismatch: true });
      return { mismatch: true };
    }

    // Limpiar errores si todo est√° bien
    if (newPassword.value === confirmPassword.value) {
      confirmPassword.setErrors(null);
    }

    return null;
  }

  /**
   * Cargar datos del usuario actual
   */
  async loadUserData(): Promise<void> {
    try {
      console.log('üîµ loadUserData - Iniciando carga...');
      this.loading = true;

      if (this.currentUser) {
        console.log('üîµ Obteniendo datos de Firestore para UID:', this.currentUser.uid);
        this.userData = await this.userService.getUserByUid(this.currentUser.uid);
        console.log('üîµ Datos obtenidos de Firestore:', this.userData);

        // Poblar el formulario con los datos actuales
        this.profileForm.patchValue({
          displayName: this.currentUser.displayName || this.userData?.displayName || ''
        });
        console.log('üîµ Formulario poblado con displayName:', this.currentUser.displayName || this.userData?.displayName || '');
      }
      console.log('‚úÖ loadUserData - Carga completada');
    } catch (error) {
      console.error('‚ùå Error cargando datos del usuario:', error);
      this.errorMessage = 'Error al cargar tus datos. Intenta de nuevo.';
    } finally {
      console.log('üîµ loadUserData - Estableciendo loading = false');
      this.loading = false;
    }
  }

  /**
   * Toggle para mostrar/ocultar secci√≥n de cambio de contrase√±a
   */
  togglePasswordChange(): void {
    this.showPasswordChange = !this.showPasswordChange;

    // Limpiar campos de contrase√±a al cerrar
    if (!this.showPasswordChange) {
      this.profileForm.patchValue({
        newPassword: '',
        confirmPassword: ''
      });
    }
  }

  /**
   * Abrir di√°logo de selecci√≥n de foto
   */
  openPhotoUpload(): void {
    this.photoInput.nativeElement.click();
  }

  /**
   * Cuando se selecciona una foto
   */
  onPhotoSelected(event: Event): void {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files[0]) {
      this.selectedFile = input.files[0];

      // Validar que sea una imagen
      if (!this.selectedFile.type.startsWith('image/')) {
        this.errorMessage = 'Por favor selecciona un archivo de imagen v√°lido';
        this.selectedFile = null;
        return;
      }

      // Validar tama√±o (max 5MB)
      if (this.selectedFile.size > 5 * 1024 * 1024) {
        this.errorMessage = 'La imagen no debe superar los 5MB';
        this.selectedFile = null;
        return;
      }

      // Subir la foto inmediatamente
      this.uploadPhoto();
    }
  }

  /**
   * Subir foto a Firebase Storage
   */
  async uploadPhoto(): Promise<void> {
    if (!this.selectedFile || !this.currentUser) return;

    try {
      this.saving = true;
      this.errorMessage = '';
      this.successMessage = '';

      const storage = getStorage();
      const fileRef = ref(storage, `profile-photos/${this.currentUser.uid}/${Date.now()}_${this.selectedFile.name}`);

      // Subir archivo
      await uploadBytes(fileRef, this.selectedFile);

      // Obtener URL de descarga
      const photoURL = await getDownloadURL(fileRef);

      // Actualizar perfil en Authentication
      await updateProfile(this.currentUser, { photoURL });

      // Actualizar en Firestore
      await this.userService.updateUserProfile(this.currentUser.uid, { photoURL });

      // Actualizar la vista
      this.currentUser.photoURL = photoURL;
      if (this.userData) {
        this.userData.photoURL = photoURL;
      }

      this.successMessage = '¬°Foto actualizada exitosamente!';
      setTimeout(() => this.successMessage = '', 3000);
    } catch (error) {
      console.error('Error subiendo foto:', error);
      this.errorMessage = 'Error al subir la foto. Intenta de nuevo.';
    } finally {
      this.saving = false;
      this.selectedFile = null;
    }
  }

  /**
   * Guardar cambios del perfil
   */
  async onSubmit(): Promise<void> {
    if (this.profileForm.invalid || !this.currentUser) return;

    try {
      this.saving = true;
      this.errorMessage = '';
      this.successMessage = '';

      const formValue = this.profileForm.value;

      // 1. Actualizar nombre si cambi√≥
      if (formValue.displayName !== this.currentUser.displayName) {
        await updateProfile(this.currentUser, {
          displayName: formValue.displayName
        });

        await this.userService.updateUserProfile(this.currentUser.uid, {
          displayName: formValue.displayName
        });
      }

      // 2. Actualizar contrase√±a si se proporcion√≥
      if (formValue.newPassword && formValue.newPassword.length >= 6) {
        await updatePassword(this.currentUser, formValue.newPassword);

        // Limpiar campos de contrase√±a
        this.profileForm.patchValue({
          newPassword: '',
          confirmPassword: ''
        });
        this.showPasswordChange = false;
      }

      // Recargar datos
      await this.loadUserData();

      this.successMessage = '¬°Perfil actualizado exitosamente!';
      setTimeout(() => this.successMessage = '', 3000);
    } catch (error: any) {
      console.error('Error actualizando perfil:', error);

      // Mensajes de error espec√≠ficos
      if (error.code === 'auth/requires-recent-login') {
        this.errorMessage = 'Por seguridad, necesitas volver a iniciar sesi√≥n para cambiar tu contrase√±a.';
      } else {
        this.errorMessage = 'Error al actualizar el perfil. Intenta de nuevo.';
      }
    } finally {
      this.saving = false;
    }
  }

  /**
   * Obtener etiqueta del rol en espa√±ol
   */
  getRoleLabel(role?: UserRole): string {
    switch (role) {
      case UserRole.ADMIN:
        return 'Administrador';
      case UserRole.PROGRAMMER:
        return 'Programador';
      case UserRole.USER:
        return 'Usuario';
      default:
        return 'Usuario';
    }
  }

  /**
   * Formatear fecha a texto legible
   */
  formatDate(date: any): string {
    if (!date) return 'No disponible';

    let dateObj: Date;

    // Convertir Timestamp de Firestore a Date
    if (date.toDate && typeof date.toDate === 'function') {
      dateObj = date.toDate();
    } else if (date instanceof Date) {
      dateObj = date;
    } else {
      dateObj = new Date(date);
    }

    return dateObj.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  /**
   * Volver al dashboard o p√°gina anterior
   */
  goBack(): void {
    // Determinar a d√≥nde volver seg√∫n el rol
    if (this.userData?.role === UserRole.ADMIN) {
      this.router.navigate(['/admin-dashboard']);
    } else if (this.userData?.role === UserRole.PROGRAMMER) {
      this.router.navigate(['/programmer-dashboard']);
    } else {
      this.router.navigate(['/portfolio']);
    }
  }
}
